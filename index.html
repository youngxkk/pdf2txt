<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 文字提取工具 | 本地处理，安全高效</title>
    
    <!-- 引入 Tailwind CSS 进行样式设计 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 FontAwesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 引入 PDF.js 库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // 配置 PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // 配置 Tailwind 主题色
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#10B981', // Emerald 500
                        dark: '#1F2937',
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* 玻璃拟态背景 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* 拖拽区域激活状态 */
        .drag-active {
            border-color: #4F46E5 !important;
            background-color: #EEF2FF !important;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen text-slate-800 font-sans selection:bg-indigo-100 selection:text-indigo-700">

    <!-- 顶部导航 -->
    <nav class="w-full glass-panel sticky top-0 z-50 border-b border-gray-100 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-md">
                        <i class="fa-solid fa-file-pdf text-xl"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-800">PDF <span class="text-indigo-600">Extractor</span></span>
                </div>
                <div class="hidden md:flex items-center text-sm text-gray-500">
                    <span class="flex items-center"><i class="fa-solid fa-shield-halved mr-2 text-emerald-500"></i> 本地处理，隐私安全</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="max-w-5xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
        
        <!-- 标题区域 -->
        <div class="text-center mb-12 animate-fade-in-up">
            <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900 mb-4 tracking-tight">
                瞬间将 PDF 转换为可编辑文本
            </h1>
            <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                上传您的文档，我们将帮您提取其中的所有文字。支持智能排版优化，一键导出 Markdown 或 TXT，完全免费。
            </p>
        </div>

        <!-- 上传区域 -->
        <div id="upload-section" class="max-w-3xl mx-auto transition-all duration-300">
            <div id="drop-zone" class="relative group cursor-pointer bg-white rounded-3xl border-2 border-dashed border-gray-300 hover:border-indigo-400 hover:shadow-xl transition-all duration-300 p-12 text-center overflow-hidden">
                
                <!-- 装饰背景圆圈 -->
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-indigo-50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
                <div class="absolute -left-10 -bottom-10 w-40 h-40 bg-purple-50 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>

                <input type="file" id="file-input" class="hidden" accept="application/pdf">
                
                <div class="relative z-10">
                    <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-sm group-hover:scale-110 transition-transform duration-300">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">点击或拖拽 PDF 文件到此处</h3>
                    <p class="text-gray-500 text-sm mb-6">支持任意大小的 PDF 文档</p>
                    <button class="bg-indigo-600 text-white px-8 py-3 rounded-full font-medium hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">
                        选择文件
                    </button>
                </div>
            </div>
        </div>

        <!-- 加载状态 (隐藏) -->
        <div id="loading-section" class="hidden max-w-3xl mx-auto text-center py-16">
            <div class="relative w-24 h-24 mx-auto mb-8">
                <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                <i class="fa-solid fa-robot absolute inset-0 flex items-center justify-center text-indigo-600 text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">正在智能识别...</h3>
            <p id="progress-text" class="text-gray-500">正在初始化解析引擎</p>
        </div>

        <!-- 结果区域 (隐藏) -->
        <div id="result-section" class="hidden animate-fade-in-up">
            
            <!-- 操作栏 -->
            <div class="bg-white rounded-t-2xl border-b border-gray-100 p-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-red-100 text-red-500 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-file-pdf"></i>
                    </div>
                    <div>
                        <h4 id="file-name" class="font-bold text-gray-800 truncate max-w-[200px]">document.pdf</h4>
                        <span id="page-count" class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">0 页</span>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2">
                    <button onclick="formatToMarkdown()" class="px-4 py-2 text-sm bg-amber-500 text-white hover:bg-amber-600 rounded-lg shadow-md shadow-amber-200 transition-all flex items-center gap-2" title="智能合并断行，优化排版">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> 一键美化
                    </button>
                    <div class="h-6 w-px bg-gray-300 mx-1 self-center hidden md:block"></div>
                    <button onclick="copyText()" class="px-4 py-2 text-sm text-gray-600 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors flex items-center gap-2">
                        <i class="fa-regular fa-copy"></i> 复制
                    </button>
                    <button onclick="downloadFile('txt')" class="px-4 py-2 text-sm bg-white border border-gray-200 text-gray-700 hover:border-gray-300 hover:bg-gray-50 rounded-lg shadow-sm transition-all flex items-center gap-2">
                        <i class="fa-solid fa-file-lines text-gray-400"></i> 导出 TXT
                    </button>
                    <button onclick="downloadFile('md')" class="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg shadow-md shadow-indigo-200 transition-all flex items-center gap-2">
                        <i class="fa-brands fa-markdown"></i> 导出 MD
                    </button>
                    <button onclick="resetApp()" class="ml-2 px-3 py-2 text-gray-400 hover:text-red-500 transition-colors" title="重新开始">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>
            </div>

            <!-- 编辑器区域 -->
            <div class="bg-white rounded-b-2xl shadow-xl border border-gray-200 h-[600px] flex flex-col relative">
                <div class="absolute top-4 right-6 text-xs text-gray-400 pointer-events-none z-10">可编辑区域</div>
                <textarea id="output-text" class="w-full h-full p-6 resize-none focus:outline-none focus:bg-gray-50/50 transition-colors custom-scrollbar text-gray-700 leading-relaxed font-mono text-sm" spellcheck="false" placeholder="解析的内容将显示在这里..."></textarea>
            </div>

            <!-- 提示信息 -->
            <p class="text-center text-gray-400 text-sm mt-6">
                <i class="fa-solid fa-circle-info mr-1"></i> 提示：点击“一键美化”可自动合并由于 PDF 格式导致的断行。
            </p>
        </div>

    </main>

    <!-- 页脚 -->
    <footer class="border-t border-gray-200 mt-12 py-8 bg-white/50 backdrop-blur-sm">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">© 2024 PDF Extractor Tool. Designed for Efficiency.</p>
        </div>
    </footer>

    <!-- Toast 通知容器 -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        // DOM 元素引用
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const loadingSection = document.getElementById('loading-section');
        const resultSection = document.getElementById('result-section');
        const outputText = document.getElementById('output-text');
        const fileNameEl = document.getElementById('file-name');
        const pageCountEl = document.getElementById('page-count');
        const progressText = document.getElementById('progress-text');

        let currentFileName = 'document';

        // 事件监听：点击上传
        dropZone.addEventListener('click', () => fileInput.click());

        // 事件监听：文件选择
        fileInput.addEventListener('change', handleFileSelect);

        // 事件监听：拖拽
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('drag-active');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-active');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'application/pdf') {
                    processPDF(file);
                } else {
                    showToast('请上传 PDF 格式的文件', 'error');
                }
            }
        }

        // 核心功能：处理 PDF
        async function processPDF(file) {
            // UI 状态切换
            uploadSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            currentFileName = file.name.replace('.pdf', '');
            fileNameEl.textContent = file.name;

            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // 加载 PDF 文档
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                const pdf = await loadingTask.promise;
                
                pageCountEl.textContent = `${pdf.numPages} 页`;
                
                let fullText = "";

                // 循环遍历页面
                for (let i = 1; i <= pdf.numPages; i++) {
                    progressText.textContent = `正在解析第 ${i} / ${pdf.numPages} 页...`;
                    
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    // 提取文本项并拼接
                    let lastY = -1;
                    let pageText = "";
                    
                    for (const item of textContent.items) {
                        // 简单的分行逻辑：如果Y坐标变化较大，则换行
                        if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > 10) {
                            pageText += "\n";
                        } else if (lastY !== -1) {
                            pageText += " "; // 同一行加空格
                        }
                        
                        pageText += item.str;
                        lastY = item.transform[5];
                    }

                    // 添加页眉分隔符
                    fullText += `--- 第 ${i} 页 ---\n\n${pageText}\n\n\n`;
                }

                // 完成
                outputText.value = fullText;
                loadingSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                showToast('解析成功！点击“一键美化”优化排版');

            } catch (error) {
                console.error(error);
                loadingSection.classList.add('hidden');
                uploadSection.classList.remove('hidden');
                showToast('解析失败，请检查文件是否损坏或加密', 'error');
            }
        }

        // 功能：一键美化 Markdown 格式
        function formatToMarkdown() {
            let text = outputText.value;
            if (!text) {
                showToast('没有可处理的文字', 'error');
                return;
            }

            showToast('正在智能排版...', 'success');

            // 1. 统一换行符
            text = text.replace(/\r\n/g, '\n');

            // 2. 将页码分隔符转换为 Markdown 标题
            // 原始: --- 第 1 页 ---
            // 目标: ## 第 1 页
            text = text.replace(/^--- 第 (\d+) 页 ---$/gm, '\n## 第 $1 页\n');

            // 3. 智能合并断行
            const lines = text.split('\n');
            let newLines = [];
            let buffer = '';

            // 判断是否为中文字符的正则
            const isCJK = (str) => /[\u4e00-\u9fa5]/.test(str);

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                // 如果是空行
                if (line.length === 0) {
                    if (buffer) { 
                        newLines.push(buffer); 
                        buffer = ''; 
                    }
                    newLines.push(''); // 保留一个空行作为段落分隔
                    continue;
                }

                // 如果是标题 (以 # 开头) 或 列表项 (数字. 或 - 或 •)
                // 这些通常是独立的行，不应被合并到上一行
                if (line.startsWith('#') || line.match(/^(\d+\.|-|•|\*)\s+/)) {
                    if (buffer) { 
                        newLines.push(buffer); 
                        buffer = ''; 
                    }
                    newLines.push(line);
                    continue;
                }

                // 合并逻辑：
                // 如果 buffer 为空，直接存入 buffer
                if (!buffer) {
                    buffer = line;
                } else {
                    // 如果 buffer 不为空，需要决定如何连接
                    const lastChar = buffer.slice(-1);
                    const firstChar = line[0];

                    // 如果两个都是中文，直接连接（不加空格）
                    if (isCJK(lastChar) && isCJK(firstChar)) {
                        buffer += line;
                    } else {
                        // 否则（英文或混排），加个空格
                        buffer += ' ' + line;
                    }
                }

                // 启发式判断段落结束：
                // 如果行尾是结束标点 (. ! ? 。 ！ ？ ” ")，或者行很短（可能是标题但没识别出来）
                // 则认为这行是段落的结尾，刷新 buffer
                if (/[.!?。！？”"]$/.test(line) || (line.length < 50 && !line.match(/[,，、]/))) {
                    newLines.push(buffer);
                    buffer = '';
                }
            }
            
            // 处理剩余的 buffer
            if (buffer) newLines.push(buffer);

            // 重新组合
            text = newLines.join('\n');

            // 4. 清理多余空行 (超过2个换行替换为2个)
            text = text.replace(/\n{3,}/g, '\n\n');

            // 更新文本框
            outputText.value = text;
            showToast('格式美化完成！');
        }

        // 功能：复制文本
        function copyText() {
            outputText.select();
            document.execCommand('copy');
            showToast('已复制到剪贴板');
        }

        // 功能：下载文件
        function downloadFile(type) {
            let content = outputText.value;
            if (!content) return;

            let mimeType, extension, formattedContent;

            if (type === 'md') {
                mimeType = 'text/markdown';
                extension = 'md';
                // 确保有标题
                if (!content.startsWith('# ')) {
                     formattedContent = `# ${currentFileName}\n\n${content}`;
                } else {
                     formattedContent = content;
                }
            } else {
                mimeType = 'text/plain';
                extension = 'txt';
                formattedContent = content;
            }

            const blob = new Blob([formattedContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentFileName}_extracted.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`已开始下载 .${extension} 文件`);
        }

        // 功能：重置 App
        function resetApp() {
            fileInput.value = '';
            outputText.value = '';
            resultSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            currentFileName = 'document';
        }

        // UI 组件：Toast 通知
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            // 样式配置
            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-slate-800';
            const icon = type === 'error' ? '<i class="fa-solid fa-circle-xmark"></i>' : '<i class="fa-solid fa-circle-check"></i>';
            
            toast.className = `${bgClass} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 flex items-center gap-3`;
            toast.innerHTML = `${icon} <span>${message}</span>`;
            
            container.appendChild(toast);

            // 动画入口
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            // 自动移除
            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>